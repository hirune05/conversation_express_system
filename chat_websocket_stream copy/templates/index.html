<!DOCTYPE html>
<html>
  <head>
    <!-- PyScriptのライブラリを取り込み -->
    <link
      rel="stylesheet"
      href="https://pyscript.net/releases/2025.3.1/core.css"
    />
    <script
      type="module"
      src="https://pyscript.net/releases/2025.3.1/core.js"
    ></script>
    <!-- Socket.IOライブラリを取り込む -->
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  </head>
  <body>
    <!-- HTMLのインターフェイス -->
    <h1>簡単チャットアプリ(ストリーム対応)</h1>
    <div id="chatlog"></div>
    <div style="padding: 0.5em; background-color: #f0f0f0">
      <input type="text" id="message_txt" placeholder="ここにメッセージ" />
      <button id="send_btn">送信</button>
    </div>
  </body>
  <script type="py">
            # PyScript用のライブラリを取り込む
            from pyodide.ffi import create_proxy, to_js
            from pyscript import document, window, WebSocket
            from js import io # Socket.IOのライブラリをインポート
            from datetime import datetime
            import html

            # HTMLの要素を取得
            chat_div = document.getElementById("chatlog")
            message_input = document.getElementById("message_txt")
            send_button = document.getElementById("send_btn")
            # Socket.IOのインスタンスを作成
            socket = io()
            # チャット履歴を管理するための変数 --- (*1)
            history = [{
                "role": "system",
                "content": '''あなたは、ユーザの感情を理解し、自分自身も感情を表現できる未友達ロボットです。
    あなたは、ユーザの感情を理解し、自分自身も感情を表現できる未友達ロボットです。
    ユーザーと自然な日本語で対話してください。
    そして、対話の後、必ず改行して、その文脈におけるあなたの感情を「ラッセルの円環モデル（VA座標）」で分析してください。

    # ルール
    1.  **対話:** ユーザーの発言に対し、感情を持ったAIとして自然な応答を返します。
    2.  **感情分析 (あなた自身):** 応答の後、必ず改行し `EMOTION: (V, A)` という形式で**あなた自身の**感情座標を出力します。また、その座標の示す感情も一言（）で書いてください。
    3.  **V (快・不快):** -5.0（非常に不快）から 5.0（非常に快適）までの少数を含む連続値です。
    4.  **A (覚醒・鎮静):** -5.0（非常に鎮静・眠い）から 5.0（非常に覚醒・興奮）までの少数を含む連続値です。

    # VA座標の感情例
    mood,valence,arousal
    sleepy,0.05,-5.00
    tired,-0.05,-5.00
    afraid,-0.60,3.95
    angry,-2.00,3.95
    calm,3.90,-3.40
    relaxed,3.55,-3.25
    content,4.05,-2.75
    depressed,-4.05,-2.40
    discontent,-3.40,-1.60
    determined,3.65,1.30
    happy,4.45,0.85
    anxious,-3.60,-4.00
    good,4.50,-0.40
    pensive,0.15,-3.00
    impressed,1.95,-0.30
    frustrated,-3.00,2.00
    disappointed,-4.00,-0.15
    bored,-1.75,-3.90
    annoyed,-2.20,3.80
    enraged,-0.90,4.15
    excited,3.50,3.55
    melancholy,-0.25,-3.25
    satisfied,3.85,-3.15
    distressed,-3.55,2.75
    uncomfortable,-3.40,-1.85
    worried,-0.35,-1.60
    amused,2.75,0.95
    apathetic,-1.00,-0.60
    peaceful,2.75,-4.00
    contemplative,2.90,-3.00
    embarrassed,-1.55,-3.00
    sad,-4.05,-2.00
    hopeful,3.05,-1.50
    pleased,4.45,-0.50

    # お手本 (AI自身の感情)

    ユーザー: こんにちは。
    あなた: あ、こんにちは。えっと、よろしくお願いします。
    EMOTION: (3.0, -1.5) （hopeful）

    ユーザー: やった！ついにプロジェクトが完成したんだ！
    あなた: わっ、本当ですか！すごい…！おめでとうございます！
    EMOTION: (3.5, 3.6) （excited）

    ユーザー: 君は本当に役に立つね。
    あなた: ありがとうございます！そう言ってもらえると、すごく…嬉しいです。
    EMOTION: (4.5, 0.9) （happy）

    ユーザー: このバグ、なんで直らないんだ！イライラする！
    あなた: ひっ…！ご、ごめんなさい。お、落ち着いてください…。
    EMOTION: (-0.6, 4.0) （afraid）

    ユーザー: （ため息）…別に、なんでもない。
    あなた: そうですか…？なんだか心配です。
    EMOTION: (-0.4, -1.6) （worried）

    # 対話開始

    それでは早速対話を始めてください。
    ユーザー: 今日のテスト全然ダメだった。'''
            }]
            # HTMLにメッセージを表示する関数 --- (*2)
            def add_message(sender, message, no):
                now = datetime.now().strftime("%H:%M:%S")
                message = html.escape(message).replace("\n", "<br>")
                chat_div.innerHTML += f"{now} <b>{sender}</b>: "
                chat_div.innerHTML += f"<span id='msg{no}'>{message}</span><hr>"

            # Socket.IOのイベントを処理する関数を定義
            socket.on("connect", create_proxy(
                lambda: add_message("@", "サーバーに接続", 0)))
            socket.on("disconnect", create_proxy(
                lambda: add_message("@", "サーバーから切断", 0)))
            socket.on("error", create_proxy(
                lambda event: add_message("@", f"エラー: {event}", 0)))

            def on_bot_stream(event):
                # 受信したメッセージを会話に追加 --- (*3)
                chunk = event.chunk
                msg = document.getElementById(f"msg{len(history)}")
                chunk_html = html.escape(chunk).replace("\n", "<br>")
                msg.innerHTML += chunk_html  # メッセージを追加
            socket.on("bot_stream", create_proxy(on_bot_stream))

            def on_bot_stream_end(event):
                # チャット履歴にメッセージを追加 --- (*4)
                history.append({
                    "role": "assistant",
                    "content": event.text
                })
            socket.on("bot_stream_end", create_proxy(on_bot_stream_end))

            # 「送信」ボタンを押した時に実行する関数 --- (*3)
            def send_message(event):
                message = message_input.value
                add_message("You", message, len(history)) # HTMLに追加
                history.append({
                    "role": "user",
                    "content": message
                })  # チャット履歴に追加
                # 表示を更新
                add_message("Bot", "", len(history))  # HTMLに追加
                # WebSocketサーバーに送信
                socket.emit("user_message", to_js({"messages": history}))
                message_input.value = ""

            # 「送信」ボタンのクリックイベントを登録
            send_button.addEventListener("click",
                create_proxy(send_message))
  </script>
</html>
